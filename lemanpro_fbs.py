# lemanpro_fbs.py
# Калькулятор юнит-экономики Лемана Про (FBS / FBO)
# Данные: Коммерческие комиссии (февраль) + Тарифы Последней мили

import streamlit as st
import pandas as pd

# ─────────────────────────────────────────────────────────────────────────────
# 1. СПРАВОЧНИКИ КОМИССИЙ (Sheet 1: Комиссия_FBS и FBO)
# ─────────────────────────────────────────────────────────────────────────────
# Репрезентативная выборка по категориям (процент без знака %)
CATEGORY_COMMISSIONS = {
    # --- Стройматериалы ---
    "Блоки, кирпич, бетон (18%)": 18,
    "Арматура / крепёжные элементы (18%)": 18,
    "Сухие смеси / цемент (18%)": 18,
    "Кровельные покрытия (18-19%)": 18,
    "Теплоизоляция (14%)": 14,
    "Гидроизоляция / пароизоляция (14%)": 14,
    "Сэндвич-панели (18%)": 18,
    "Системы водоотведения / дренаж (22%)": 22,
    "Фасадные панели / сайдинг (19%)": 19,
    # --- Окна и двери ---
    "Окна ПВХ / алюминий (27%)": 27,
    "Мансардные окна (23%)": 23,
    "Межкомнатные двери (22%)": 22,
    "Входные двери (22%)": 22,
    "Раздвижные двери (22%)": 22,
    "Москитные сетки (24%)": 24,
    # --- Отопление ---
    "Котлы на твёрдом топливе (15%)": 15,
    "Дымоходы (26%)": 26,
    "Камины / топки (26%)": 26,
    "Электрические конвекторы (20%)": 20,
    "Электрообогреватели (23%)": 23,
    "Полотенцесушители эл. (22%)": 22,
    "Терморегуляторы (26%)": 26,
    # --- Электротовары ---
    "Розетки / выключатели (29%)": 29,
    "Кабели силовые (29%)": 29,
    "Кабель-каналы (29%)": 29,
    "Электрощиты / автоматы (28%)": 28,
    "Умный дом / датчики (10%)": 10,
    # --- Климатическая техника ---
    "Кондиционеры / сплит-системы (20%)": 20,
    "Вентиляторы / вентиляция (29%)": 29,
    "Увлажнители / очистители (20%)": 20,
    # --- Инструменты ---
    "Электроинструмент (10%)": 10,
    "Ручной инструмент (10%)": 10,
    "Оснастка / биты / свёрла (10%)": 10,
    "Станки (10%)": 10,
    "Компрессоры (10%)": 10,
    "СИЗ / спецодежда (10%)": 10,
    # --- Сантехника ---
    "Раковины / унитазы (15%)": 15,
    "Мебель для ванной (15%)": 15,
    "Смесители / арматура (15%)": 15,
    "Ванны / душевые (15%)": 15,
    "Аксессуары для ванной (15%)": 15,
    # --- Плитка / напольные ---
    "Плитка / керамогранит (10%)": 10,
    "Ламинат / паркет (10%)": 10,
    "ПВХ плитка / линолеум (10%)": 10,
    "Ковры (27%)": 27,
    # --- Краски ---
    "Краски и эмали (23%)": 23,
    "Средства против плесени (23%)": 23,
    # --- Дача и сад ---
    "Садовая техника / электро (10%)": 10,
    "Садовый очаг / барбекю (20%)": 20,
    # --- Хозтовары ---
    "Чистящие средства (27%)": 27,
    "Хозяйственный инвентарь (21%)": 21,
    # --- Мебель ---
    "Мебель для дома / офиса (10%)": 10,
    # --- Техника ---
    "Бытовая техника крупная (10%)": 10,
    "Бытовая техника малая (10%)": 10,
    # --- Другое ---
    "Крепёж / такелаж (24%)": 24,
    "Другое — указать вручную": None,
}

# ─────────────────────────────────────────────────────────────────────────────
# 2. ТАРИФЫ «ПОСЛЕДНЯЯ МИЛЯ» (Sheet 3, зоны Москва/СПБ → все зоны)
#    Формат: {(зона_откуда, зона_куда): [(max_vol_l, tariff), ..., (None, tariff, per_l)]}
#    Для простоты калькулятора используем усреднённые «типовые» ставки
#    по основным зонам. Пользователь выбирает зону склада и зону доставки.
# ─────────────────────────────────────────────────────────────────────────────

WEIGHT_BREAKS = [1, 3, 5, 10, 15, 20, 30, 50, 80, 100, 120]
WEIGHT_LABELS = ["0-1", "1-3", "3-5", "5-10", "10-15", "15-20",
                 "20-30", "30-50", "50-80", "80-100", "100-120", "от 120"]

# Тарифы Последней мили (с НДС, руб.) и надбавка за +1 л сверх 120 л
# Источник: зоны 9→Москва/СПБ/1..8 и 10→все зоны (февраль)
LAST_MILE_TARIFFS = {
    # Зона 9 (склад ЛП) → Москва и МО / СПБ и ЛО / зоны 1-3 (одинаковые ставки)
    ("9", "Москва и МО"): [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "СПБ и ЛО"):    [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "1"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "2"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "3"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "4"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "5"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "6"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "7"):            [247, 305, 333, 467, 571, 674, 801, 1112, 2012, 2479, 2821, (2821, 18)],
    ("9", "8"):            [229, 270, 332, 481, 572, 657, 836, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "9"):            [243, 310, 324, 365, 391, 464, 607, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "10"):           [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    # Зона 10 (склад ЛП) → все зоны
    ("10", "Москва и МО"): [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "СПБ и ЛО"):    [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "1"):            [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "2"):            [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "3"):            [279, 391, 409, 493, 518, 656, 905, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "4"):            [279, 391, 409, 493, 518, 656, 905, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "5"):            [284, 395, 427, 517, 545, 689, 945, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "6"):            [322, 428, 457, 535, 563, 718, 968, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "7"):            [229, 270, 332, 481, 572, 657, 836, 1385, 3049, 3715, 4198, (4198, 27)],
    ("10", "8"):            [304, 403, 431, 538, 583, 743, 1033, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "9"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("10", "10"):           [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    # Зона Москва и МО (склад) → зона доставки 9
    ("Москва и МО", "9"):  [257, 320, 365, 522, 621, 719, 914, 1390, 3055, 3722, 4207, (4207, 27)],
    ("СПБ и ЛО", "9"):     [257, 320, 365, 522, 621, 719, 914, 1390, 3055, 3722, 4207, (4207, 27)],
}

RETURN_LAST_MILE_MULT = 0.5   # Возврат ≈ 50% от тарифа (упрощение, реальные ставки аналогичны)

# Тариф Доставки до СЦ (упрощённые средние)
DELIVERY_TO_SC = {
    "Москва и МО": {1: 96, 3: 118, 5: 138, 10: 161, 15: 184, 20: 206, 30: 247, 50: 368, 80: 592, 100: 734, 120: 838},
    "СПБ и ЛО":    {1: 96, 3: 118, 5: 138, 10: 161, 15: 184, 20: 206, 30: 247, 50: 368, 80: 592, 100: 734, 120: 838},
    "Регион":      {1: 142, 3: 177, 5: 206, 10: 239, 15: 276, 20: 306, 30: 368, 50: 552, 80: 888, 100: 1101, 120: 1257},
}

# ─────────────────────────────────────────────────────────────────────────────
# 3. ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
# ─────────────────────────────────────────────────────────────────────────────

def get_last_mile_tariff(zone_from: str, zone_to: str, volume_l: float) -> float:
    """Возвращает тариф Последней мили для заданных зон и объёма отправления."""
    key = (zone_from, zone_to)
    if key not in LAST_MILE_TARIFFS:
        # Попробуем об
