# lemanpro_fbs.py
# –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏ –õ–µ–º–∞–Ω–∞ –ü—Ä–æ (FBS / FBO)
# –î–∞–Ω–Ω—ã–µ: –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –∫–æ–º–∏—Å—Å–∏–∏ (—Ñ–µ–≤—Ä–∞–ª—å) + –¢–∞—Ä–∏—Ñ—ã –ü–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–ª–∏

import streamlit as st
import pandas as pd

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 1. –°–ü–†–ê–í–û–ß–ù–ò–ö–ò –ö–û–ú–ò–°–°–ò–ô (Sheet 1: –ö–æ–º–∏—Å—Å–∏—è_FBS –∏ FBO)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –†–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–ø—Ä–æ—Ü–µ–Ω—Ç –±–µ–∑ –∑–Ω–∞–∫–∞ %)
CATEGORY_COMMISSIONS = {
    # --- –°—Ç—Ä–æ–π–º–∞—Ç–µ—Ä–∏–∞–ª—ã ---
    "–ë–ª–æ–∫–∏, –∫–∏—Ä–ø–∏—á, –±–µ—Ç–æ–Ω (18%)": 18,
    "–ê—Ä–º–∞—Ç—É—Ä–∞ / –∫—Ä–µ–ø—ë–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (18%)": 18,
    "–°—É—Ö–∏–µ —Å–º–µ—Å–∏ / —Ü–µ–º–µ–Ω—Ç (18%)": 18,
    "–ö—Ä–æ–≤–µ–ª—å–Ω—ã–µ –ø–æ–∫—Ä—ã—Ç–∏—è (18-19%)": 18,
    "–¢–µ–ø–ª–æ–∏–∑–æ–ª—è—Ü–∏—è (14%)": 14,
    "–ì–∏–¥—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è / –ø–∞—Ä–æ–∏–∑–æ–ª—è—Ü–∏—è (14%)": 14,
    "–°—ç–Ω–¥–≤–∏—á-–ø–∞–Ω–µ–ª–∏ (18%)": 18,
    "–°–∏—Å—Ç–µ–º—ã –≤–æ–¥–æ–æ—Ç–≤–µ–¥–µ–Ω–∏—è / –¥—Ä–µ–Ω–∞–∂ (22%)": 22,
    "–§–∞—Å–∞–¥–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ / —Å–∞–π–¥–∏–Ω–≥ (19%)": 19,
    # --- –û–∫–Ω–∞ –∏ –¥–≤–µ—Ä–∏ ---
    "–û–∫–Ω–∞ –ü–í–• / –∞–ª—é–º–∏–Ω–∏–π (27%)": 27,
    "–ú–∞–Ω—Å–∞—Ä–¥–Ω—ã–µ –æ–∫–Ω–∞ (23%)": 23,
    "–ú–µ–∂–∫–æ–º–Ω–∞—Ç–Ω—ã–µ –¥–≤–µ—Ä–∏ (22%)": 22,
    "–í—Ö–æ–¥–Ω—ã–µ –¥–≤–µ—Ä–∏ (22%)": 22,
    "–†–∞–∑–¥–≤–∏–∂–Ω—ã–µ –¥–≤–µ—Ä–∏ (22%)": 22,
    "–ú–æ—Å–∫–∏—Ç–Ω—ã–µ —Å–µ—Ç–∫–∏ (24%)": 24,
    # --- –û—Ç–æ–ø–ª–µ–Ω–∏–µ ---
    "–ö–æ—Ç–ª—ã –Ω–∞ —Ç–≤—ë—Ä–¥–æ–º —Ç–æ–ø–ª–∏–≤–µ (15%)": 15,
    "–î—ã–º–æ—Ö–æ–¥—ã (26%)": 26,
    "–ö–∞–º–∏–Ω—ã / —Ç–æ–ø–∫–∏ (26%)": 26,
    "–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω–≤–µ–∫—Ç–æ—Ä—ã (20%)": 20,
    "–≠–ª–µ–∫—Ç—Ä–æ–æ–±–æ–≥—Ä–µ–≤–∞—Ç–µ–ª–∏ (23%)": 23,
    "–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ—Å—É—à–∏—Ç–µ–ª–∏ —ç–ª. (22%)": 22,
    "–¢–µ—Ä–º–æ—Ä–µ–≥—É–ª—è—Ç–æ—Ä—ã (26%)": 26,
    # --- –≠–ª–µ–∫—Ç—Ä–æ—Ç–æ–≤–∞—Ä—ã ---
    "–†–æ–∑–µ—Ç–∫–∏ / –≤—ã–∫–ª—é—á–∞—Ç–µ–ª–∏ (29%)": 29,
    "–ö–∞–±–µ–ª–∏ —Å–∏–ª–æ–≤—ã–µ (29%)": 29,
    "–ö–∞–±–µ–ª—å-–∫–∞–Ω–∞–ª—ã (29%)": 29,
    "–≠–ª–µ–∫—Ç—Ä–æ—â–∏—Ç—ã / –∞–≤—Ç–æ–º–∞—Ç—ã (28%)": 28,
    "–£–º–Ω—ã–π –¥–æ–º / –¥–∞—Ç—á–∏–∫–∏ (10%)": 10,
    # --- –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ ---
    "–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä—ã / —Å–ø–ª–∏—Ç-—Å–∏—Å—Ç–µ–º—ã (20%)": 20,
    "–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä—ã / –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—è (29%)": 29,
    "–£–≤–ª–∞–∂–Ω–∏—Ç–µ–ª–∏ / –æ—á–∏—Å—Ç–∏—Ç–µ–ª–∏ (20%)": 20,
    # --- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ---
    "–≠–ª–µ–∫—Ç—Ä–æ–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (10%)": 10,
    "–†—É—á–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (10%)": 10,
    "–û—Å–Ω–∞—Å—Ç–∫–∞ / –±–∏—Ç—ã / —Å–≤—ë—Ä–ª–∞ (10%)": 10,
    "–°—Ç–∞–Ω–∫–∏ (10%)": 10,
    "–ö–æ–º–ø—Ä–µ—Å—Å–æ—Ä—ã (10%)": 10,
    "–°–ò–ó / —Å–ø–µ—Ü–æ–¥–µ–∂–¥–∞ (10%)": 10,
    # --- –°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ ---
    "–†–∞–∫–æ–≤–∏–Ω—ã / —É–Ω–∏—Ç–∞–∑—ã (15%)": 15,
    "–ú–µ–±–µ–ª—å –¥–ª—è –≤–∞–Ω–Ω–æ–π (15%)": 15,
    "–°–º–µ—Å–∏—Ç–µ–ª–∏ / –∞—Ä–º–∞—Ç—É—Ä–∞ (15%)": 15,
    "–í–∞–Ω–Ω—ã / –¥—É—à–µ–≤—ã–µ (15%)": 15,
    "–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã –¥–ª—è –≤–∞–Ω–Ω–æ–π (15%)": 15,
    # --- –ü–ª–∏—Ç–∫–∞ / –Ω–∞–ø–æ–ª—å–Ω—ã–µ ---
    "–ü–ª–∏—Ç–∫–∞ / –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç (10%)": 10,
    "–õ–∞–º–∏–Ω–∞—Ç / –ø–∞—Ä–∫–µ—Ç (10%)": 10,
    "–ü–í–• –ø–ª–∏—Ç–∫–∞ / –ª–∏–Ω–æ–ª–µ—É–º (10%)": 10,
    "–ö–æ–≤—Ä—ã (27%)": 27,
    # --- –ö—Ä–∞—Å–∫–∏ ---
    "–ö—Ä–∞—Å–∫–∏ –∏ —ç–º–∞–ª–∏ (23%)": 23,
    "–°—Ä–µ–¥—Å—Ç–≤–∞ –ø—Ä–æ—Ç–∏–≤ –ø–ª–µ—Å–µ–Ω–∏ (23%)": 23,
    # --- –î–∞—á–∞ –∏ —Å–∞–¥ ---
    "–°–∞–¥–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ / —ç–ª–µ–∫—Ç—Ä–æ (10%)": 10,
    "–°–∞–¥–æ–≤—ã–π –æ—á–∞–≥ / –±–∞—Ä–±–µ–∫—é (20%)": 20,
    # --- –•–æ–∑—Ç–æ–≤–∞—Ä—ã ---
    "–ß–∏—Å—Ç—è—â–∏–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ (27%)": 27,
    "–•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (21%)": 21,
    # --- –ú–µ–±–µ–ª—å ---
    "–ú–µ–±–µ–ª—å –¥–ª—è –¥–æ–º–∞ / –æ—Ñ–∏—Å–∞ (10%)": 10,
    # --- –¢–µ—Ö–Ω–∏–∫–∞ ---
    "–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –∫—Ä—É–ø–Ω–∞—è (10%)": 10,
    "–ë—ã—Ç–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –º–∞–ª–∞—è (10%)": 10,
    # --- –î—Ä—É–≥–æ–µ ---
    "–ö—Ä–µ–ø—ë–∂ / —Ç–∞–∫–µ–ª–∞–∂ (24%)": 24,
    "–î—Ä—É–≥–æ–µ ‚Äî —É–∫–∞–∑–∞—Ç—å –≤—Ä—É—á–Ω—É—é": None,
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 2. –¢–ê–†–ò–§–´ ¬´–ü–û–°–õ–ï–î–ù–Ø–Ø –ú–ò–õ–Ø¬ª (Sheet 3, –∑–æ–Ω—ã –ú–æ—Å–∫–≤–∞/–°–ü–ë ‚Üí –≤—Å–µ –∑–æ–Ω—ã)
#    –§–æ—Ä–º–∞—Ç: {(–∑–æ–Ω–∞_–æ—Ç–∫—É–¥–∞, –∑–æ–Ω–∞_–∫—É–¥–∞): [(max_vol_l, tariff), ..., (None, tariff, per_l)]}
#    –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–µ ¬´—Ç–∏–ø–æ–≤—ã–µ¬ª —Å—Ç–∞–≤–∫–∏
#    –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –∑–æ–Ω–∞–º. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –∑–æ–Ω—É —Å–∫–ª–∞–¥–∞ –∏ –∑–æ–Ω—É –¥–æ—Å—Ç–∞–≤–∫–∏.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

WEIGHT_BREAKS = [1, 3, 5, 10, 15, 20, 30, 50, 80, 100, 120]
WEIGHT_LABELS = ["0-1", "1-3", "3-5", "5-10", "10-15", "15-20",
                 "20-30", "30-50", "50-80", "80-100", "100-120", "–æ—Ç 120"]

# –¢–∞—Ä–∏—Ñ—ã –ü–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–ª–∏ (—Å –ù–î–°, —Ä—É–±.) –∏ –Ω–∞–¥–±–∞–≤–∫–∞ –∑–∞ +1 –ª —Å–≤–µ—Ä—Ö 120 –ª
# –ò—Å—Ç–æ—á–Ω–∏–∫: –∑–æ–Ω—ã 9‚Üí–ú–æ—Å–∫–≤–∞/–°–ü–ë/1..8 –∏ 10‚Üí–≤—Å–µ –∑–æ–Ω—ã (—Ñ–µ–≤—Ä–∞–ª—å)
LAST_MILE_TARIFFS = {
    # –ó–æ–Ω–∞ 9 (—Å–∫–ª–∞–¥ –õ–ü) ‚Üí –ú–æ—Å–∫–≤–∞ –∏ –ú–û / –°–ü–ë –∏ –õ–û / –∑–æ–Ω—ã 1-3 (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å—Ç–∞–≤–∫–∏)
    ("9", "–ú–æ—Å–∫–≤–∞ –∏ –ú–û"): [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "–°–ü–ë –∏ –õ–û"):    [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "1"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "2"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "3"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "4"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "5"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "6"):            [296, 368, 382, 448, 503, 608, 809, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "7"):            [247, 305, 333, 467, 571, 674, 801, 1112, 2012, 2479, 2821, (2821, 18)],
    ("9", "8"):            [229, 270, 332, 481, 572, 657, 836, 1385, 3049, 3715, 4198, (4198, 27)],
    ("9", "9"):            [243, 310, 324, 365, 391, 464, 607, 1152, 2083, 2569, 2938, (2938, 18)],
    ("9", "10"):           [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    # –ó–æ–Ω–∞ 10 (—Å–∫–ª–∞–¥ –õ–ü) ‚Üí –≤—Å–µ –∑–æ–Ω—ã
    ("10", "–ú–æ—Å–∫–≤–∞ –∏ –ú–û"): [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "–°–ü–ë –∏ –õ–û"):    [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "1"):            [315, 419, 431, 499, 518, 662, 891, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "2"):            [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "3"):            [279, 391, 409, 493, 518, 656, 905, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "4"):            [279, 391, 409, 493, 518, 656, 905, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "5"):            [284, 395, 427, 517, 545, 689, 945, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "6"):            [322, 428, 457, 535, 563, 718, 968, 2194, 3316, 4243, 4865, (4865, 36)],
    ("10", "7"):            [229, 270, 332, 481, 572, 657, 836, 1385, 3049, 3715, 4198, (4198, 27)],
    ("10", "8"):            [304, 403, 431, 538, 583, 743, 1033, 2223, 3437, 4307, 5027, (5027, 36)],
    ("10", "9"):            [257, 319, 364, 521, 620, 718, 913, 1385, 3049, 3715, 4198, (4198, 27)],
    ("10", "10"):           [319, 422, 440, 511, 536, 684, 925, 2194, 3316, 4243, 4865, (4865, 36)],
    # –ó–æ–Ω–∞ –ú–æ—Å–∫–≤–∞ –∏ –ú–û (—Å–∫–ª–∞–¥) ‚Üí –∑–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ 9
    ("–ú–æ—Å–∫–≤–∞ –∏ –ú–û", "9"):  [257, 320, 365, 522, 621, 719, 914, 1390, 3055, 3722, 4207, (4207, 27)],
    ("–°–ü–ë –∏ –õ–û", "9"):     [257, 320, 365, 522, 621, 719, 914, 1390, 3055, 3722, 4207, (4207, 27)],
}

RETURN_LAST_MILE_MULT = 0.5   # –í–æ–∑–≤—Ä–∞—Ç ‚âà 50% –æ—Ç —Ç–∞—Ä–∏—Ñ–∞ (—É–ø—Ä–æ—â–µ–Ω–∏–µ, —Ä–µ–∞–ª—å–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã)

# –¢–∞—Ä–∏—Ñ –î–æ—Å—Ç–∞–≤–∫–∏ –¥–æ –°–¶ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Å—Ä–µ–¥–Ω–∏–µ)
DELIVERY_TO_SC = {
    "–ú–æ—Å–∫–≤–∞ –∏ –ú–û": {1: 96, 3: 118, 5: 138, 10: 161, 15: 184, 20: 206, 30: 247, 50: 368, 80: 592, 100: 734, 120: 838},
    "–°–ü–ë –∏ –õ–û":    {1: 96, 3: 118, 5: 138, 10: 161, 15: 184, 20: 206, 30: 247, 50: 368, 80: 592, 100: 734, 120: 838},
    "–†–µ–≥–∏–æ–Ω":      {1: 142, 3: 177, 5: 206, 10: 239, 15: 276, 20: 306, 30: 368, 50: 552, 80: 888, 100: 1101, 120: 1257},
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# 3. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

def get_last_mile_tariff(zone_from: str, zone_to: str, volume_l: float) -> float:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞—Ä–∏—Ñ –ü–æ—Å–ª–µ–¥–Ω–µ–π –º–∏–ª–∏ –¥–ª—è –∑–∞–¥–∞–Ω–Ω—ã—Ö –∑–æ–Ω –∏ –æ–±—ä—ë–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    key = (zone_from, zone_to)
    if key not in LAST_MILE_TARIFFS:
        # –ü–æ–ø—Ä–æ–±—É–µ–º –æ–±

        reverse_key = (zone_to, zone_from)
        if reverse_key in LAST_MILE_TARIFFS:
            key = reverse_key
        else:
            return 0.0
    tariffs = LAST_MILE_TARIFFS[key]
    breaks = WEIGHT_BREAKS
    for i, max_w in enumerate(breaks):
        if volume_l <= max_w:
            return float(tariffs[i])
    last = tariffs[-1]
    if isinstance(last, tuple):
        base, per_l = last
        return float(base) + (volume_l - breaks[-1]) * float(per_l)
    return float(last)


def get_delivery_to_sc(region: str, weight_kg: float) -> float:
    tbl = DELIVERY_TO_SC.get(region, DELIVERY_TO_SC["–†–µ–≥–∏–æ–Ω"])
    breaks = sorted(tbl.keys())
    for b in breaks:
        if weight_kg <= b:
            return float(tbl[b])
    return float(tbl[breaks[-1]])


# ---------------------------------------------------------------------------
# 4. RENDER ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏–∑ app.py
# ---------------------------------------------------------------------------
def render(conn, get_ai_category, normalize_value, calc_tax):
    st.header("üèóÔ∏è –õ–µ–º–∞–Ω–∞ –ü—Ä–æ (FBS) ‚Äî –†–∞—Å—á—ë—Ç —é–Ω–∏—Ç-—ç–∫–æ–Ω–æ–º–∏–∫–∏")

    with st.sidebar:
        st.subheader("‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Å—Ç–∏–∫–∏")
        zone_from = st.selectbox("–ó–æ–Ω–∞ —Å–∫–ª–∞–¥–∞ –ø—Ä–æ–¥–∞–≤—Ü–∞", ["9", "10", "–ú–æ—Å–∫–≤–∞ –∏ –ú–û", "–°–ü–ë –∏ –õ–û"], key="lp_zf")
        zone_to = st.selectbox("–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—é", ["–ú–æ—Å–∫–≤–∞ –∏ –ú–û", "–°–ü–ë –∏ –õ–û", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], key="lp_zt")
        delivery_region = st.selectbox("–†–µ–≥–∏–æ–Ω —Å–∫–ª–∞–¥–∞ (–¥–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –°–¶)", ["–ú–æ—Å–∫–≤–∞ –∏ –ú–û", "–°–ü–ë –∏ –õ–û", "–†–µ–≥–∏–æ–Ω"], key="lp_dr")
        include_return = st.checkbox("–£—á–∏—Ç—ã–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç (50% —Ç–∞—Ä–∏—Ñ–∞)", value=False, key="lp_ret")

    st.header("1. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤")
    up_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel (–∞—Ä—Ç–∏–∫—É–ª, –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å, –≤–µ—Å)",
        type=["xlsx"], key="lp_upload"
    )
    df_raw = None
    if up_file:
        df_raw = pd.read_excel(up_file)
        df_raw.columns = [c.lower().strip() for c in df_raw.columns]
        if st.button("üì• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –±–∞–∑–µ", key="lp_save"):
            cursor = conn.cursor()
            for _, r in df_raw.iterrows():
                l = normalize_value(r.get("–¥–ª–∏–Ω–∞", 0), "dim")
                h = normalize_value(r.get("–≤—ã—Å–æ—Ç–∞", 0), "dim")
                w = normalize_value(r.get("—à–∏—Ä–∏–Ω–∞", 0), "dim")
                wg = normalize_value(r.get("–≤–µ—Å", 0), "weight")
                cursor.execute(
                    "INSERT OR REPLACE INTO products VALUES (?, ?, ?, ?, ?, ?)",
                    (str(r.get("–∞—Ä—Ç–∏–∫—É–ª")), str(r.get("–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ")), l, h, w, wg)
                )
            conn.commit()
            st.success("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")

    st.divider()
    st.header("2. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞")

    col1, col2, col3, col4 = st.columns(4)
    with col1: target_m = st.number_input("–¢–∞—Ä–≥–µ—Ç –º–∞—Ä–∂–∞, %", value=20.0, key="lp_margin")
    with col2: acquiring = st.number_input("–≠–∫–≤–∞–π—Ä–∏–Ω–≥, %", value=0.0, key="lp_acq")
    with col3: marketing = st.number_input("–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, %", value=0.0, key="lp_mkt")
    with col4: extra_costs = st.number_input("–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã, —Ä—É–±/—à—Ç", value=0.0, key="lp_extra")

    tax_regime = st.selectbox("–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è", [
        "–û–°–ù–û", "–£–°–ù (–î–æ—Ö–æ–¥—ã)", "–£–°–ù (–î–æ—Ö–æ–¥—ã-–†–∞—Å—Ö–æ–¥—ã)", "–ê–£–°–ù", "–£–°–ù —Å –ù–î–° 5%", "–£–°–ù —Å –ù–î–° 7%"
    ], key="lp_tax")

    if st.button("üí∏ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –†–†–¶ –¥–ª—è –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤", key="lp_calc"):
        cursor = conn.cursor()
        cursor.execute("SELECT * FROM products")
        all_products = cursor.fetchall()
        if not all_products:
            st.warning("–ë–∞–∑–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø—É—Å—Ç–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã.")
            return

        cat_list = list(CATEGORY_COMMISSIONS.keys())
        results = []

        for p in all_products:
            sku, name, length, height, width, weight = p
            volume_l = (length * height * width) / 1000 if all([length, height, width]) else 1.0

            cat = get_ai_category(name, cat_list)
            comm = CATEGORY_COMMISSIONS.get(cat)
            if comm is None:
                comm = 18.0

            cost = 0.0
            if df_raw is not None and "–∞—Ä—Ç–∏–∫—É–ª" in df_raw.columns:
                try:
                    cost = float(df_raw[df_raw["–∞—Ä—Ç–∏–∫—É–ª"].astype(str) == str(sku)]["—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å"].values[0])
                except Exception:
                    cost = 0.0

            lm_tariff = get_last_mile_tariff(zone_from, zone_to, volume_l)
            sc_tariff = get_delivery_to_sc(delivery_region, weight)
            return_cost = lm_tariff * RETURN_LAST_MILE_MULT if include_return else 0.0
            logistics_total = lm_tariff + sc_tariff + return_cost

            k_percent = comm + marketing + acquiring
            denom = 1 - (k_percent / 100) - (target_m / 100)

            if denom > 0 and cost > 0:
                rrc = (cost + logistics_total + extra_costs) / denom
            else:
                rrc = 0

            if rrc > 0:
                percent_costs = rrc * (k_percent / 100)
                profit_before_tax = rrc - cost - logistics_total - extra_costs - percent_costs
                tax_amount = calc_tax(rrc, profit_before_tax, tax_regime)
                profit_after_tax = profit_before_tax - tax_amount
                margin_before = (profit_before_tax / rrc) * 100
                margin_after = (profit_after_tax / rrc) * 100
            else:
                percent_costs = profit_before_tax = tax_amount = profit_after_tax = margin_before = margin_after = 0

            results.append({
                "–ê—Ä—Ç–∏–∫—É–ª": sku,
                "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ": name,
                "–ö–∞—Ç–µ–≥–æ—Ä–∏—è": cat,
                "–ö–æ–º–∏—Å—Å–∏—è, %": round(comm, 2),
                "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, %": round(marketing, 2),
                "–≠–∫–≤–∞–π—Ä–∏–Ω–≥, %": round(acquiring, 2),
                "–û–±—ä—ë–º, –ª": round(volume_l, 2),
                "–í–µ—Å, –∫–≥": round(weight, 2),
                "–ü–æ—Å–ª–µ–¥–Ω—è—è –º–∏–ª—è, —Ä—É–±": round(lm_tariff, 2),
                "–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –°–¶, —Ä—É–±": round(sc_tariff, 2),
                "–í–æ–∑–≤—Ä–∞—Ç, —Ä—É–±": round(return_cost, 2),
                "–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –∏—Ç–æ–≥–æ, —Ä—É–±": round(logistics_total, 2),
                "–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã, —Ä—É–±": round(extra_costs, 2),
                "–ó–∞–∫—É–ø–∫–∞, —Ä—É–±": round(cost, 2),
                "–†–†–¶, —Ä—É–±": round(rrc, 0),
                "–ü—Ä–∏–±—ã–ª—å –¥–æ –Ω–∞–ª–æ–≥–∞, —Ä—É–±": round(profit_before_tax, 0),
                "–ù–∞–ª–æ–≥, —Ä—É–±": round(tax_amount, 0),
                "–ü—Ä–∏–±—ã–ª—å –ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–∞, —Ä—É–±": round(profit_after_tax, 0),
                "–ú–∞—Ä–∂–∞ –¥–æ –Ω–∞–ª–æ–≥–∞, %": round(margin_before, 1),
                "–ú–∞—Ä–∂–∞ –ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–∞, %": round(margin_after, 1),
            })

        res_df = pd.DataFrame(results)
        st.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á—ë—Ç–∞")
        st.dataframe(res_df, use_container_width=True)
        st.download_button(
            "üì• –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç (CSV)",
            res_df.to_csv(index=False).encode("utf-8"),
            "lemanpro_results.csv",
            mime="text/csv"
        )
